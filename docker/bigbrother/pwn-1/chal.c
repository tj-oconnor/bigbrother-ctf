#include <stdio.h>
#include <stdlib.h>
#include <signal.h>
#include <stdint.h>

__attribute__((constructor)) void ignore_me()
{
    setbuf(stdin, NULL);
    setbuf(stdout, NULL);
    setbuf(stderr, NULL);
}

void slow_printf(char *text)
{
    for (int i = 0; text[i] != '\0'; i++)
    {
        putchar(text[i]);
        fflush(stdout);
        usleep(5000);
    }
}

void logo()
{
    printf("-----------------------------------------------------------------------------\n");
    printf("'##::::'##:'####:'##::: ##:'####::'######::'########:'########::'##:::'##::::\n");
    printf(" ###::'###:. ##:: ###:: ##:. ##::'##... ##:... ##..:: ##.... ##:. ##:'##:::::\n");
    printf(" ####'####:: ##:: ####: ##:: ##:: ##:::..::::: ##:::: ##:::: ##::. ####::::::\n");
    printf(" ## ### ##:: ##:: ## ## ##:: ##::. ######::::: ##:::: ########::::. ##:::::::\n");
    printf(" ##. #: ##:: ##:: ##. ####:: ##:::..... ##:::: ##:::: ##.. ##:::::: ##:::::::\n");
    printf(" ##:.:: ##:: ##:: ##:. ###:: ##::'##::: ##:::: ##:::: ##::. ##::::: ##:::::::\n");
    printf(" ##:::: ##:'####: ##::. ##:'####:. ######::::: ##:::: ##:::. ##:::: ##:::::::\n");
    printf("..:::::..::....::..::::..::....:::......::::::..:::::..:::::..:::::..::::::::\n");
    printf(":'#######::'########::::'########:'########::'##::::'##:'########:'##::::'##:\n");
    printf("'##.... ##: ##.....:::::... ##..:: ##.... ##: ##:::: ##:... ##..:: ##:::: ##:\n");
    printf(" ##:::: ##: ##::::::::::::: ##:::: ##:::: ##: ##:::: ##:::: ##:::: ##:::: ##:\n");
    printf(" ##:::: ##: ######::::::::: ##:::: ########:: ##:::: ##:::: ##:::: #########:\n");
    printf(" ##:::: ##: ##...:::::::::: ##:::: ##.. ##::: ##:::: ##:::: ##:::: ##.... ##:\n");
    printf(" ##:::: ##: ##::::::::::::: ##:::: ##::. ##:: ##:::: ##:::: ##:::: ##:::: ##:\n");
    printf(". #######:: ##::::::::::::: ##:::: ##:::. ##:. #######::::: ##:::: ##:::: ##:\n");
    printf(":.......:::..::::::::::::::..:::::..:::::..:::.......::::::..:::::..:::::..::\n");
    printf("-----------------------------------------------------------------------------\n");
}

void sigsegv_handler(int signal)
{
    uint64_t *rbp_value = 0;
    __asm__("mov %%rbp, %0;"
            : "=r"(rbp_value));
    if (*rbp_value == 0x4E4E4E4E4E4E4E4E)
    {
        system("cat flag.txt");
    }
    else
    {
        slow_printf("<<< You are mad\n");
    }
    exit(0);
}

void vuln()
{
    signal(SIGSEGV, sigsegv_handler);
    char buf[8];
    slow_printf("There is truth and there is untruth. Do you cling to the truth >>> ");
    read(0, &buf, 24);
}

int main()
{
    logo();
    vuln();
    slow_printf("<<< Thank you. Your input has been recorded with the RECDEP\n");
}
